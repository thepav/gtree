<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=UTF-8" />
<meta charset="utf-8" />
<title>Georgia Tech Arboretum</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta content="" name="description" />
<meta content="" name="author" />
    
<link href="assets/plugins/jquery-metrojs/MetroJs.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="assets/plugins/shape-hover/css/demo.css" />
<link rel="stylesheet" type="text/css" href="assets/plugins/shape-hover/css/component.css" />
<link href="assets/plugins/pace/pace-theme-flash.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="assets/plugins/jquery-slider/css/jquery.sidr.light.css" rel="stylesheet" type="text/css" media="screen"/>

<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>


<!-- BEGIN CORE CSS FRAMEWORK -->
<link href="assets/plugins/boostrapv3/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<link href="assets/plugins/boostrapv3/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css"/>
<link href="assets/plugins/font-awesome/css/font-awesome.css" rel="stylesheet" type="text/css"/>
<link href="assets/css/animate.min.css" rel="stylesheet" type="text/css"/>
<link href="assets/plugins/jquery-scrollbar/jquery.scrollbar.css" rel="stylesheet" type="text/css"/>
<!-- END CORE CSS FRAMEWORK -->

<!-- BEGIN CSS TEMPLATE -->
<link href="assets/css/style.css" rel="stylesheet" type="text/css"/>
<link href="assets/css/responsive.css" rel="stylesheet" type="text/css"/>
<link href="assets/css/custom-icon-set.css" rel="stylesheet" type="text/css"/>
<link href="assets/css/magic_space.css" rel="stylesheet" type="text/css"/>
<link href="assets/css/footer.css" rel="stylesheet" type="text/css"/>
<!-- END CSS TEMPLATE -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.12/proj4.js" type="text/javascript"></script>
<link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css">
<script src="http://js.arcgis.com/3.14/" type="text/javascript"></script>
<script type="text/javascript" src="gis/js/getcard.js"></script>
<style type="text/css">
.row-eq-height {
display: -webkit-box;
display: -webkit-flex;
display: -ms-flexbox;
display:         flex;
}
</style>
</head>
<!-- END HEAD -->
<!-- BEGIN BODY -->
<body class="">
<!-- BEGIN HEADER -->
<div class="header navbar navbar-inverse ">
  <!-- BEGIN TOP NAVIGATION BAR -->
  <div class="navbar-inner">
    <div class="header-seperation">
      <ul class="nav pull-left notifcation-center" id="main-menu-toggle-wrapper" style="display:none">
        <li class="dropdown"> <a id="main-menu-toggle" href="#main-menu"  class="" >
          <div class="iconset top-menu-toggle-dark"></div>
          </a> </li>
      </ul>
      <!-- BEGIN LOGO -->
      <a href="index.html"><img src="assets/img/gtreelogo.png" class="logo" alt=""  data-src="assets/img/gtreelogo.png" data-src-retina="assets/img/gtreelogo.png" width="106"/></a>
      <!-- END LOGO -->
      <ul class="nav pull-right notifcation-center">
        <li class="dropdown" id="header_task_bar"> <a href="index.html" class="dropdown-toggle active" data-toggle="">
          <div class="glyphicon glyphicon-home"></div>
          </a> </li>
      </ul>
    </div>
    <!-- END RESPONSIVE MENU TOGGLER -->
    <div class="header-quick-nav" >
      <!-- BEGIN TOP NAVIGATION MENU -->
      <div class="pull-left">
        <ul class="nav quick-section">
          <li class="quicklinks"> <a href="#" class="" id="layout-condensed-toggle" >
            <div class="iconset top-menu-toggle-dark"></div>
            </a> </li>
        </ul>
        <ul class="nav quick-section">
          <li class="quicklinks"> <a href="story_submit.html" class="" >
            <div class="glyphicon glyphicon-plus"></div>
            </a> </li>

          <li class="m-r-10 input-prepend inside search-form no-boarder"> <span class="add-on"> <span class="iconset top-search"></span></span>
            <input name="" type="text"  class="no-boarder " placeholder="Search Dashboard" style="width:250px;">
          </li>
        </ul>
      </div>
      <!-- END TOP NAVIGATION MENU -->
      <!-- BEGIN CHAT TOGGLER -->
        <!-- removed -->
      <!-- END CHAT TOGGLER -->
    </div>
    <!-- END TOP NAVIGATION MENU -->
  </div>
  <!-- END TOP NAVIGATION BAR -->
</div>
<!-- END HEADER -->
<!-- BEGIN CONTAINER -->
<div class="page-container row-fluid">
  <!-- BEGIN SIDEBAR -->
  <div class="page-sidebar" id="main-menu">
    <!-- BEGIN MINI-PROFILE -->
    <div class="page-sidebar-wrapper scrollbar-dynamic" id="main-menu-wrapper">
      <!-- END MINI-PROFILE -->
      <!-- BEGIN SIDEBAR MENU -->
      <p class="menu-title">BROWSE <span class="pull-right"></span></p>
      <ul>
        <li class="start "> 
          <a href="index.html">
            <i class="glyphicon glyphicon-home"></i>
            <span class="title">Dashboard</span>
          </a> 
        </li>
        <li class="">
          <a href="#">
            <i class="glyphicon glyphicon-map-marker"></i>
            <span class="title">Campus Map</span>
          </a>
        </li>
        <li class="">
          <a href="story_submit.html">
            <i class="glyphicon glyphicon-pencil"></i>
            <span class="title">Share Your Story</span>
          </a>
        </li>

        <li class="hidden-lg hidden-md hidden-xs" id="more-widgets" > <a href="javascript:;"> <i class="glyphicon glyphicon-globe"></i></a>
          <ul class="sub-menu">
            <li class="side-bar-widgets">
              <p class="menu-title">TOURS <span class="pull-right"><a href="#" class="create-folder"><i class="icon-plus"></i></a></span></p>
              <ul class="folders" >
                <li><a href="#">
                  <div class="status-icon green"></div>
                  Tech Green </a> </li>
                <li><a href="#">
                  <div class="status-icon red"></div>
                  West Campus </a> </li>
                <li><a href="#">
                  <div class="status-icon blue"></div>
                  Hill Tour </a> </li>
                <li class="folder-input" style="display:none">
                  <input type="text" placeholder="Name of folder" class="no-boarder folder-name" name="" id="folder-name">
                </li>
              </ul>
              <p class="menu-title">ONGOING PROJECTS </p>
              <div class="status-widget">
                <div class="status-widget-wrapper">
                  <div class="title">Temperature Study</div>
                  <p>Measuring rooftop surface temperatures</p>
                </div>
              </div>
              <div class="status-widget">
                <div class="status-widget-wrapper">
                  <a class="title" href="http://imagine.gatech.edu/node/509">Virtual Reality</a>
                  <p>Virtual reality arboretum tours</p>
                </div>
              </div>
            </li>
          </ul>
        </li>
      </ul>
      <div class="side-bar-widgets">
        <p class="menu-title">TOURS</p>
        <ul class="folders" >
          <li><a href="#">
            <div class="status-icon green"></div>
            Tech Green </a> </li>
          <li><a href="#">
            <div class="status-icon red"></div>
            West Campus </a> </li>
          <li><a href="#">
            <div class="status-icon blue"></div>
            Hill Tour </a> </li>
          <li class="folder-input" style="display:none">
            <input type="text" placeholder="Name of folder" class="no-boarder folder-name" name="" >
          </li>
        </ul>
        <p class="menu-title">ONGOING PROJECTS </p>
        <div class="status-widget">
          <div class="status-widget-wrapper">
            <div class="title">Temperature Study</div>
            <p>Rooftop surface temperatures</p>
          </div>
        </div>
        <div class="status-widget">
          <div class="status-widget-wrapper">
            <a class="title" href="http://imagine.gatech.edu/node/509">Virtual Reality</a>
            <p>Virtual reality arboretum tours</p>
          </div>
        </div>
      </div>
      <div class="clearfix"></div>
      <!-- END SIDEBAR MENU -->
    </div>
  </div>
  <div class="footer-widget">
    <div class="progress transparent progress-small no-radius no-margin">
      <div data-percentage="79%" class="progress-bar progress-bar-success animate-progress-bar" ></div>
    </div>
    <div class="pull-right">
      <div class="details-status" > <span data-animation-duration="560" data-value="86" class="animate-number"></span>% </div>
      <a href="lockscreen.html">Tours</a></div>
  </div>
  <!-- END SIDEBAR -->
  <!-- BEGIN PAGE CONTAINER-->
  <div class="page-content container-fluid">
    <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
    <div id="portlet-config" class="modal hide">
      <div class="modal-header">
        <button data-dismiss="modal" class="close" type="button"></button>
        <h3>Widget Settings</h3>
      </div>
      <div class="modal-body"> Widget settings form goes here </div>
    </div>
    <div class="clearfix"></div>
    <div class="content sm-gutter">
      <div class="page-title">
      </div>
	   <!-- BEGIN DASHBOARD TILES -->
	  <div id='tourRow' class="row">	 
  	     <div></div>
	  </div>
	  <!-- END DASHBOARD TILES -->
  <div class="row" >
		<!-- BEGIN WORLD MAP WIDGET - MAP -->
    <div class="col-md-12 col-vlg-8 m-b-10">
      <div id="gis_map"></div>
    </div>
        <!-- END WORLD MAP WIDGET - CRAFT MAP -->
		
	</div>
   
  <div  id='article_trees' class="row" >
      <!-- BEGIN BLOG POST BIG IMAGE WIDGET -->
    <div class="col-md-6 col-vlg-4 col-sm-12 " style="display:none;">			
      <div class="tiles overflow-hidden full-height tiles-overlay-hover m-b-10 widget-item">
		    <div class="controller overlay right"> <a href="javascript:;" class="reload"></a> <a href="javascript:;" class="remove"></a> </div>
        <div class="overlayer tiles-overlay auto blue">
          <div class="overlayer-wrapper  p-t-20 p-l-20 p-r-20 p-b-20"> <i class="fa fa-map-marker fa-2x"></i>
            <p class="p-t-20 text-white-opacity">17 Sep</p>
            <h3 class="text-white">School of Architecture professors named <span class="semi-bold">best architect </span>by Creative Loafing </h3>
          </div>
        </div>
        <img src="assets/img/others/9.jpg" data-src="assets/img/others/9.jpg" data-src-retina="assets/img/others/rob.jpg" alt="" class="image-responsive-width hover-effect-img"> 
			</div>
    </div>
		    <!-- END BLOG POST BIG IMAGE WIDGET -->
	
      
	</div>
  <div class="row">
    <div id='info' class="row row-height" >

    </div>
  </div>

  <!-- #footer/ -->
  <footer id="footer" role="contentinfo">
    <div class="row clearfix">
      <div id="footer-utility-links">
        <div role="navigation" aria-label="Site Utility" class="gt-footer-utility-links-wrapper login-link-included">
          <ul class="menu gt-footer-utility-links">
            <li class="menu-378 first last"><a href="http://www.space.gatech.edu/contact-us" title="">Contact Us</a></li>
          </ul>
        </div>
        <div class="gt-footer-legal-links-wrapper" role="navigation" aria-label="Legal">
          <ul class="menu gt-footer-legal-links custom-links-included login-link-included">
            <li class="first"><a href="http://www.gatech.edu/emergency/">Emergency Information</a></li>
            <li><a href="http://www.gatech.edu/legal/">Legal &amp; Privacy Information</a></li>
            <li><a href="http://www.gatech.edu/accessibility/">Accessibility</a></li>
            <li><a href="http://www.gatech.edu/accountability/">Accountability</a></li>
            <li><a href="https://www.gatech.edu/accreditation/">Accreditation</a></li>
            <li class="last"><a href="http://www.careers.gatech.edu">Employment</a></li>
          </ul>
        </div>
      </div>
      <div id="footer-logo">
        <a href="http://www.gatech.edu/"><img alt="Georgia Tech" src="assets/img/gt-logo-footer-retina.png" /></a>
        <p>&copy; 2015 Georgia Institute of Technology</p>
      </div>
    </div>
  </footer>  <!-- /#footer -->

</div>

		  </div>
  
</div>

<!-- END CONTAINER -->
<!-- BEGIN CORE JS FRAMEWORK-->
    
<!--[if lt IE 9]>
<script src="assets/plugins/respond.js"></script>
<![endif]-->

<script src="assets/plugins/jquery-1.8.3.min.js" type="text/javascript"></script>
<script src="assets/plugins/jquery-ui/jquery-ui-1.10.1.custom.min.js" type="text/javascript"></script>
<script src="assets/plugins/boostrapv3/js/bootstrap.min.js" type="text/javascript"></script>
<script src="assets/plugins/breakpoints.js" type="text/javascript"></script>
<script src="assets/plugins/jquery-unveil/jquery.unveil.min.js" type="text/javascript"></script>
<script src="assets/plugins/jquery-block-ui/jqueryblockui.js" type="text/javascript"></script>
<script src="assets/plugins/jquery-lazyload/jquery.lazyload.min.js" type="text/javascript"></script>
<script src="assets/plugins/jquery-scrollbar/jquery.scrollbar.min.js" type="text/javascript"></script>
<!-- END CORE JS FRAMEWORK -->
<!-- BEGIN PAGE LEVEL JS -->
<script src="assets/plugins/jquery-slider/jquery.sidr.min.js" type="text/javascript"></script>
<script src="assets/plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
<script src="assets/plugins/pace/pace.min.js" type="text/javascript"></script>
<script src="assets/plugins/jquery-numberAnimate/jquery.animateNumbers.js" type="text/javascript"></script>
    
<script src="assets/plugins/jquery-flot/jquery.flot.js" type="text/javascript"></script>
<script src="assets/plugins/jquery-flot/jquery.flot.resize.min.js" type="text/javascript"></script>
<script src="assets/plugins/jquery-metrojs/MetroJs.min.js" type="text/javascript" ></script>
<!-- END PAGE LEVEL PLUGINS -->
<!-- BEGIN CORE TEMPLATE JS -->
<script src="assets/js/core.js" type="text/javascript"></script>
<script type="text/javascript">
        $(document).ready(function () {
            $(".live-tile,.flip-list").liveTile();
        });
</script>
<script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
<script type="text/javascript">
  var map;
  var currentLocation =[2226425.3,1374118.6];
  var locationMarker;
  var statePlaneSpatialReference;

  require(["esri/map", "esri/geometry/Point", 
        "esri/symbols/SimpleMarkerSymbol", "esri/symbols/SimpleLineSymbol",
        "esri/graphic", "esri/Color", "esri/SpatialReference",
        "esri/layers/ArcGISTiledMapServiceLayer", "esri/config", "dojo/domReady!"], 
        function(Map, Point, SimpleMarkerSymbol, SimpleLineSymbol, 
          Graphic, Color, SpatialReference, ArcGISTiledMapServiceLayer, esriConfig) {

    // define West Georgia State Plane parameters
    statePlaneSpatialReference = new SpatialReference('PROJCS["NAD83 / Georgia West (ftUS)",GEOGCS["GCS_North_American_1983",DATUM["D_North_American_1983",SPHEROID["GRS_1980",6378137,298.257222101]],PRIMEM["Greenwich",0],UNIT["Degree",0.017453292519943295]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",30],PARAMETER["central_meridian",-84.16666666666667],PARAMETER["scale_factor",0.9999],PARAMETER["false_easting",2296583.333],PARAMETER["false_northing",0],UNIT["Foot_US",0.30480060960121924]]');
    proj4.defs("EPSG2240", "+proj=tmerc +lat_0=30 +lon_0=-84.16666666666667 +k=0.9999 +x_0=699999.9998983998 +y_0=0 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs");

    // enable POSTing to ArcGIS server
    esriConfig.defaults.io.corsEnabledServers.push("tulip.gis.gatech.edu:6080");

    function updateLocationMarker(pt){
      if (!locationMarker) {
        var symbol = new SimpleMarkerSymbol(
          SimpleMarkerSymbol.STYLE_CIRCLE, 
          12, 
          new SimpleLineSymbol(
            SimpleLineSymbol.STYLE_SOLID,
            new Color([10, 10, 215, 0.3]), 
            8
          ), 
          new Color([10, 10, 215, 0.9])
        );
        locationMarker = new Graphic(pt, symbol);
        map.graphics.add(locationMarker);
      } else {
        locationMarker.setGeometry(pt);
      }
    }

    function positionUpdate(position) {
      currentLocation = proj4('WGS84', "EPSG2240", [position.coords.longitude, position.coords.latitude]);
      var pt = new Point(currentLocation, statePlaneSpatialReference);
      updateLocationMarker(pt);
      updateEverything(firebaseData);
    }

    function mapInit(map) {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(positionUpdate);
      }
    }

    map = new Map("gis_map", {
      center: [0, 0],
      zoom: 3,
      minZoom: 3,
      logo: false
    });
    var treeLayer = new ArcGISTiledMapServiceLayer("http://tulip.gis.gatech.edu:6080/arcgis/rest/services/zGT/TreeBasemap/MapServer");
    map.addLayer(treeLayer);
    map.on("load", mapInit);
  });

  // Create a connection to your Firebase database
  var ref = new Firebase("https://gtarboretum.firebaseio.com");
  var theCards;
  var currentTour = null;
  var injectedTrees = [];
  var firebaseData = null;

  var locationReferences = null;

  function updateEverything() {
    var data = firebaseData;
    if (data == null){
      return;
    }
    var order = data.val().order;
    var wrapperApplied = false;
    var numInfo = 1;

    locationReferences = data.val()["locations"];

    //  Globals which should be set before calling this function:
    //
    //  int    polyCorners  =  how many corners the polygon has
    //  float  polyX[]      =  horizontal coordinates of corners
    //  float  polyY[]      =  vertical coordinates of corners
    //  float  x, y         =  point to be tested
    //
    //  (Globals are used in this example for purposes of speed.  Change as
    //  desired.)
    //
    //  The function will return YES if the point x,y is inside the polygon, or
    //  NO if it is not.  If the point is exactly on the edge of the polygon,
    //  then the function may return YES or NO.
    //
    //  Note that division by zero is avoided because the division is protected
    //  by the "if" clause which surrounds it.


    function injectTourCardHTML(cardID,data,tourData){
      console.log('the data I got back from GIS for '+data.name+' '+tourData);
      $("#tourRow").html(" \
        <div class='col-md-12 col-vlg-12 col-sm-12'> \
          <div class='tiles "+data.color+" m-b-10'> \
            <div class='tiles-body'> \
              <div class='controller'> \
                <a href='javascript:;' class='reload'></a> \
                <a href='javascript:;' class='remove'></a> \
              </div> \
              <div class='tiles-title text-black'>"+data.name+" </div> \
              <div class='widget-stats'> \
                <div class='wrapper transparent'> \
                  <span class='item-title'>"+data.data[0].name+"</span> \
                  <span class='item-count animate-number semi-bold' data-value='753' data-animation-duration='700'>"+tourData[0]+"</span> \
                </div> \
              </div> \
              <div class='widget-stats'> \
                <div class='wrapper transparent'> \
                  <span class='item-title'>"+data.data[1].name+"</span> \
                  <span class='item-count animate-number semi-bold' data-value='1197325' data-animation-duration='700'>"+tourData[1]+"</span> \
                </div> \
              </div> \
              <div class='widget-stats '> \
                <div class='wrapper last'> \
                  <span class='item-title'>"+data.data[2].name+"</span> \
                  <span class='item-count animate-number semi-bold' data-value='547' data-animation-duration='700'>"+tourData[2]+"</span> \
                </div> \
              </div> \
              <div class='progress transparent progress-small no-radius m-t-20' style='width:90%'> \
                <div class='progress-bar progress-bar-white animate-progress-bar' data-percentage='64.8%' ></div> \
              </div> \
              <div class='description'> \
                <span class='text-white mini-description '> \
                  4% higher <span class='blend'>than last month</span> \
                </span> \
              </div> \
            </div> \
          </div> \
        </div>");
    }

    function injectPieChartCardHTML(cardID,data,cardData){
      console.log('pie chart data I got back from GIS: '+cardData);
      console.log(cardData);
      var title1 = data.title.split(' ')[0];
      var title2 = data.title.substring(title1.length); 

      $('#info').append("<div id='"+cardID+"' class='col-md-4' style='max-height:450px;min-height:450px;'><div class='grid simple' style='max-height:450px;min-height:450px;'><div class='grid-title no-border' style='max-height:55px;'><h4>"+data.name+"</h4><div class='tools'><a href='#' class='reload'></a><a href='#' class='remove'></a></div></div><div class='grid-body no-border' style='min-height:395px;'><h4>"+title1+"<span class='semi-bold'>"+title2+"</span></h4><p>"+ data.body +"</p><div id='"+cardID+"-donut-chart' style='height:200px;'> </div></div></div></div>");

      var trees = Object.keys(cardData[0]);
      var data = [];
      for(var i=0;i<trees.length;i++){
        var lab = trees[i];
        var val = cardData[0][trees[i]];
        data.push({label:lab,value:val});
      }

      Morris.Donut({
        element: cardID+'-donut-chart',
        data: data,
        colors:['#60bfb6','#91cdec','#eceff1','#eeb211']
      });
    }
    function injectTreesHTML(cardID,data,cardData){
      console.log('tree data GIS: '+cardData);
      console.log(cardData);
      var i = 0
      while($.inArray(cardData[0][i],injectedTrees)>=0){
        i = i+1;
        if (i == 7){
          return;
        }
      }

      injectedTrees.push(cardData[0][i]);
      injectedTrees.push(cardData[0][i+1]);


      
      $('#info').append( '\
        <div id="'+cardID+'" class="col-md-4 col-vlg-4 col-sm-12"> \
          <div class="row " style="max-height:220px"> \
            <div class="col-md-12 col-sm-12 m-b-10"  data-aspect-ratio="true" style="max-height:220px"> \
              <div class="tiles ha overflow-hidden" style="max-height:220px"> \
                <div class="overlayer bottom-left fullwidth"> \
                  <div class="overlayer-wrapper"> \
                    <div class="tiles gradient-black p-l-20 p-r-20 p-b-20 p-t-20"> \
                      <h5 class="text-white semi-bold ">'+cardData[0][i]+'</h5> \
                      <p class="text-white semi-bold no-margin"><i class="icon-custom-up "></i> Read More</p> \
                    </div> \
                  </div> \
                </div> \
                <img src="assets/img/others/tree2.jpg" alt="" class="image-responsive-width xs-image-responsive-width"> \
              </div> \
            </div> \
          </div> \
          <div class="row" style="max-height:221px"> \
            <div class="col-md-12 col-sm-12 m-b-10" data-start-now="true" data-aspect-ratio="true" style="max-height:220px"> \
              <div class="tiles ha overflow-hidden" style="max-height:220px"> \
                <div class="overlayer bottom-left fullwidth"> \
                  <div class="overlayer-wrapper"> \
                    <div class="tiles gradient-black p-l-20 p-r-20 p-b-20 p-t-20"> \
                      <h5 class="text-white semi-bold ">'+cardData[0][i+1]+'</h5> \
                      <p class="text-white semi-bold no-margin"><i class="icon-custom-up "></i> Read More</p> \
                    </div> \
                  </div> \
                </div> \
                <img src="assets/img/others/tree2.jpg" alt="" class="image-responsive-width xs-image-responsive-width"> \
              </div> \
            </div> \
          </div> \
        </div>');
    }


    
    var injectionFunctions = {
                                'tour_summary':injectTourCardHTML,
                                'pie_distribution':injectPieChartCardHTML,
                                'nearby_trees': injectTreesHTML
                             };


    function checkInside(currentLocation, locationData) {

      function insidePolygon(point, vs) {
          // ray-casting algorithm based on
          // http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html

          var x = point[0], y = point[1];

          var inside = false;
          for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
              var xi = vs[i]['x'], yi = vs[i]['y'];
              var xj = vs[j]['x'], yj = vs[j]['y'];

              var intersect = ((yi > y) != (yj > y))
                  && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
              if (intersect) inside = !inside;
          }

          return inside;
      }

      switch (locationData.locationtype) {
        case "reference":
          return insidePolygon(currentLocation, locationReferences[locationData.reference]);
          break;
        case "boundary":
          return insidePolygon(currentLocation, locationData.bounds);
          break;
        case "circle":
          var distance = Math.sqrt(Math.pow(currentLocation.x - locationData.centerX, 2), Math.pow(currentLocation.y - location.centerY, 2));
          return (distance < location.radius);
          break;
        default:
          return false;
      }
    }

    theCards = Object.keys(data.val().cards);    
    for (var i = 0; i < theCards.length; i++) {
      var cardName = theCards[i];
      var card = data.val().cards[cardName];

      if (card.type != 'nearby_trees'){
      
        // If my location is inside the area polygon defined by the 
        var isInside = false;
        for (var j = 0; j < card.location.length; j++) {
          var locationData = card.location[j];
          if (checkInside(currentLocation, locationData)) {
            isInside = true;
          }
        }
      }

      //var isInside = insidePolygon(data.val().globalValues[data.val().globalValues.aMyLocation],data.val().cards[theCards[i]].location);
      if (card.type == 'nearby_trees' || isInside ) {

        // Check if you're inside a new tour area
        if (card.type =='tour_summary' && cardName != currentTour){

          // Fade out the old tour card, fetch new data and insert the new tour card.
          $('#tourRow div').fadeOut('fast');
          console.log('inserting '+cardName);
          var statList = [];
          cardData = card.data;
          for (var j = 0; j < cardData.length; j++){
            statList.push(cardData[j].type);
          }
          
          // tour cards always have reference location bounds
          var locationArea = [];
          var reference = locationReferences[card.location[0].reference];
          for (var j = 0; j < reference.length; j++) {
            var coords = reference[j];
            locationArea.push([coords.x,coords.y]);
          }

          getStatistics(statList,
                        locationArea,
                        card,
                        cardName,
                        injectTourCardHTML);
          currentTour = cardName;

        // If there is a data field inside this card, we will query the data first.
        } else if ($.inArray('data',Object.keys(card)) >= 0) {
          console.log('not tour_summary or new tour summary and has data');
          // Remove card if it already exists
          if ($('#'+cardName).length){
              $('#'+cardName).remove();
          }

          // If you're not in a new tour area, or this card isn't even a tour_summary card then just insert the card. 
          
          // Generate the list of statistics this card needs.
          var statList = [];
          cardData = card.data;
          for (var j = 0; j < cardData.length; j++) {
            statList.push(cardData[j].type);
          }
          
          var locationArea = [];
          var reference = locationReferences[card.location[0].reference];
          if(reference){
            for (var j = 0; j < reference.length; j++) {
              var coords = reference[j];
              locationArea.push([coords.x,coords.y]);
            }
          }else {
            locationArea = [
              [currentLocation[0]-500,currentLocation[1]-500],
              [currentLocation[0]+500,currentLocation[1]-500],
              [currentLocation[0]+500,currentLocation[1]+500],
              [currentLocation[0]-500,currentLocation[1]+500],
            ];
          }

          // Query those statistics from GIS and inject this card into the HTML on the callback.
          getStatistics(statList,
                        locationArea,
                        card,
                        cardName,
                        injectionFunctions[card.type]);

        //If there is no data to query we simply inject the card.
        } else {
          injectionFunctions[card.type](cardName,card);
        }
      } else {
        if ($('#'+theCards[i]).length){
            $('#'+theCards[i]).remove();
        }
      }
    }

    function createStoryCardHTML(story) {
      var htmlElement = '\
      <div class="col-md-4 col-s-6 m-b-10 storycard"> \
        <div class="widget-item "> \
          <div class="controller overlay right"> \
            <a href="javascript:;" class="reload"></a> \
            <a href="javascript:;" class="remove"></a> \
          </div> \
          <div class="tiles green  overflow-hidden full-height" style="max-height:214px"> \
            <div class="overlayer bottom-right fullwidth"> \
              <div class="overlayer-wrapper"> \
                <div class="tiles gradient-black p-l-20 p-r-20 p-b-20 p-t-20"> \
                  <div class="pull-right"> \
                    <a href="#" class="hashtags transparent"> #' + story.tags[0] + '</a> \
                  </div> \
                  <div class="clearfix"></div> \
                </div> \
              </div> \
            </div> \
            <img src="' + story.file + '" alt="" class="lazy hover-effect-img" width="100%" > \
          </div> \
          <div class="tiles white" style="max-height:236px; min-height:236px;"> \
            <div class="tiles-body full-height"> \
              <div class="row"> \
                <div class="col-md-5 no-padding"> \
                  <div class="user-comment-wrapper"> \
                    <div class="comment"> \
                      <div class="user-name text-black bold">' +  story.name + '</div> \
                    </div> \
                    <div class="clearfix"></div> \
                  </div> \
                </div> \
                <div class="col-md-7 no-padding"> \
                  <div class="clearfix"></div> \
                  <div class="m-r-20 m-t-20 m-b-10  m-l-10"> \
                    <p class="p-b-10">' + story.story + '</p>';

      for (tag in story.tags) {
        htmlElement = htmlElement + '<a href="#" class="hashtags m-b-5"> #' + story.tags[tag] + '</a>';
      }

      htmlElement = htmlElement + '</div></div></div></div></div></div></div>';

      return $(htmlElement);
    }

    stories = data.val().stories;
    storyCards = [];
    $(".storycard").remove();
    for (var key in stories) {
      story = stories[key];
      if (story.visible) {
        storyCards.push(createStoryCardHTML(story));
      }
    }
    $('#info').append(storyCards);
  }

  // Listen for realtime changes
  ref.on("value", function(data){
    firebaseData = data;
    updateEverything();
  });

</script>


<!-- END CORE TEMPLATE JS -->
</body>
</html>
